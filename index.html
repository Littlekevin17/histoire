<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Générateur d'Histoire Interactive IA - OpenRouter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Comic Sans MS', cursive, sans-serif;
      background: #f0f6fc;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 480px;
      margin: 40px auto;
      background: white;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #1cb69b;
      margin-bottom: 20px;
    }
    .question, .story {
      font-size: 1.18em;
      margin-bottom: 18px;
      white-space: pre-line;
    }
    label {
      display: block;
      margin: 13px 0 6px;
    }
    input, select {
      padding: 8px;
      width: 90%;
      border-radius: 7px;
      border: 1px solid #bbb;
      font-size: 1em;
    }
    button {
      margin: 14px 0;
      background: #1cb69b;
      color: white;
      font-size: 1.08em;
      border: none;
      border-radius: 8px;
      padding: 11px;
      width: 100%;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #148f7d;
    }
    .choices button {
      margin: 8px 0;
      width: 100%;
      font-size: 1.1em;
    }
    .loader {
      text-align: center;
    }
    .footer {
      font-size: 0.85em;
      color: #888;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Histoire Interactive IA</h1>
    <div id="app">
      Chargement...
    </div>
    <div class="footer">
      Généré avec <a href="https://openrouter.ai" target="_blank" rel="noopener noreferrer">OpenRouter</a>
    </div>
  </div>

  <script src="https://sdk.openrouter.ai/v1.3.2/openrouter.js"></script>
  <script>
    // --- Variables d'état ---
    const state = {
      step: 0,               // 0 à 4 : création héros, puis aventure
      heroName: "",
      heroType: "",
      place: "",
      magicItem: "",
      storyType: "",
      history: [],           // choix faits (numéros)
      currentParagraph: "",
      currentChoices: [],
      gameActive: false,
    };

    // Étapes de configuration du héros
    const setupSteps = [
      {
        label: "Choisis un prénom pour le héros ou l’héroïne.",
        input: "text",
        key: "heroName"
      },
      {
        label: "Sélectionne un type de héros :",
        input: "select",
        key: "heroType",
        options: ["Chevalier ou chevalière", "Fée", "Explorateur·rice", "Robot", "Pirate", "Magicien·ne"]
      },
      {
        label: "Choisis le lieu de l’aventure :",
        input: "select",
        key: "place",
        options: ["Forêt enchantée", "Château ancien", "Île mystérieuse", "Montagne magique", "École extraordinaire"]
      },
      {
        label: "Choisis un objet magique essentiel à l’aventure :",
        input: "select",
        key: "magicItem",
        options: ["Épée brillante", "Cape invisible", "Médaillon aux animaux", "Baguette magique", "Livre volant"]
      },
      {
        label: "Quel type d’histoire souhaites-tu vivre ?",
        input: "select",
        key: "storyType",
        options: ["Aventure mystère", "Histoire drôle", "Voyage", "Enquête", "École magique"]
      }
    ];

    // Instance OpenRouter client
    const client = new OpenRouter();

    // Fonction pour afficher la configuration (étapes création héros)
    function renderSetup() {
      const s = setupSteps[state.step];
      let html = `<div class="question">${s.label}</div>`;
      if (s.input === "text") {
        html += `<input id="inputField" type="text" value="${state[s.key] || ""}" placeholder="Ex : Jade, Léo, Mira" />`;
      } else if (s.input === "select") {
        html += `<select id="inputField">` + s.options.map(opt =>
          `<option${state[s.key] === opt ? " selected" : ""}>${opt}</option>`
        ).join('') + `</select>`;
      }
      html += `<button id="btnValidate">Valider</button>`;
      document.getElementById("app").innerHTML = html;

      document.getElementById("btnValidate").onclick = () => {
        const val = document.getElementById("inputField").value.trim();
        if (val.length === 0) {
          alert("Merci de faire un choix ou d'entrer un texte.");
          return;
        }
        state[setupSteps[state.step].key] = val;
        state.step++;
        if (state.step < setupSteps.length) {
          renderSetup();
        } else {
          startAdventure();
        }
      };
    }

    // Fonction pour démarrer l’aventure après la configuration
    async function startAdventure() {
      state.gameActive = true;
      state.history = [];
      await requestNextStep();
    }

    // Fonction pour afficher un loader pendant requête IA
    function showLoader(text = "L'intelligence artificielle réfléchit...") {
      document.getElementById("app").innerHTML = `
        <div class="loader">
          <img src="https://media.giphy.com/media/3o7TKx2UxU8x9fzjMQ/giphy.gif" alt="Chargement" height="38" />
          <p>${text}</p>
        </div>
      `;
    }

    // Fonction qui construit le prompt pour l'IA selon l'état actuel
    function buildPrompt() {
      return `
Génère un paragraphe d'une histoire interactive pour enfant de 8 ans, avec :

- Héros/héroïne : ${state.heroName}, qui est un(e) ${state.heroType}
- Lieu : ${state.place}
- Objet magique : ${state.magicItem}
- Type d'histoire : ${state.storyType}
- Historique des choix précédents : ${JSON.stringify(state.history)}

Écris un paragraphe narratif clair, joyeux, adapté aux 8 ans, qui propose un petit défi ou un choix. Ensuite, propose 3 choix numérotés (1, 2, 3), sans révéler l’issue.

Format exact :
PARAGRAPHE
CHOIX :
1. ...
2. ...
3. ...
`;
    }

    // Fonction pour demander à l’IA la suite de l’histoire via OpenRouter
    async function requestNextStep() {
      showLoader();

      const prompt = buildPrompt();

      try {
        const response = await client.chat.completions.create({
          model: "openai/gpt-3.5-turbo", // modèle accessible sans clé sur OpenRouter
          messages: [{ role: "user", content: prompt }],
          temperature: 0.8,
          max_tokens: 500,
        });

        // Extraction contenu renvoyé
        const content = response.choices[0].message.content;

        // Sépare paragraphe et choix
        const parts = content.split("CHOIX :");
        state.currentParagraph = parts[0].trim();

        // Extraction des choix en tableau
        state.currentChoices = [];
        if (parts[1]) {
          parts[1]
            .split("\n")
            .map(line => line.trim())
            .filter(line => /^\d\./.test(line))
            .forEach(line => {
              state.currentChoices.push(line.replace(/^\d\.\s*/, ""));
            });
        }

        renderStory();
      } catch (error) {
        document.getElementById("app").innerHTML = `
          <div>
            <p><strong>Erreur lors de l'appel à l’IA :</strong> ${error.message}</p>
            <button id="btnRetry">Réessayer</button>
          </div>
        `;
        document.getElementById("btnRetry").onclick = () => requestNextStep();
      }
    }

    // Affiche le paragraphe et les choix à l’écran
    function renderStory() {
      let html = `<div class="story">${state.currentParagraph}</div><div class="choices">`;
      state.currentChoices.forEach((choice, i) => {
        html += `<button onclick="choose(${i + 1})">${i + 1}. ${choice}</button>`;
      });
      html += "</div>";
      document.getElementById("app").innerHTML = html;
    }

    // Gère le choix de l’utilisateur, stocke et relance la requête IA
    async function choose(choiceNum) {
      if (!state.gameActive) return;
      state.history.push(choiceNum);
      await requestNextStep();
    }

    // Initialisation : démarrer la config héros
    renderSetup();

    // Expose choix à global pour être accessible dans onclick inline
    window.choose = choose;
  </script>
</body>
</html>
